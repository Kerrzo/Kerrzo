<!DOCTYPE html>

<html lang="en">

<head>
	<title>BOVR Player</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" rel="stylesheet" href="main.css">
	<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon">
</head>

<body onorientationchange="changeOrientation(event);">
	<div id="overlay">
		<button id="startButton">Watch Movie</button>
	</div>

	<video id="video" loop crossOrigin="anonymous" autoplay playsinline style="display:none">
		<source src="https://testvideosfromneon8.s3-ap-southeast-2.amazonaws.com/Little+Match+Girl-1440s-3D-16mbps.mp4"
			type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
	</video>

	<script type="module">

		import * as THREE 						from '/three/build/three.module.js';
		import { DeviceOrientationControls } 	from '/three/examples/jsm/controls/DeviceOrientationControls.js';

		let camera, scene, renderer, controls, video, texture;

		const views = [
			{	// left eye
				layer: 1,
				uvOffset: 0,
				viewPort: new THREE.Vector4(0, 0, window.innerWidth / 2, window.innerHeight),
				camera: new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1100),
			},
			{	// right eye
				layer: 2,
				uvOffset: 0.5,
				viewPort: new THREE.Vector4(window.innerWidth / 2, 0, window.innerWidth / 2, window.innerHeight),
				camera: new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1100),
			}
		];

		const startButton = document.getElementById('startButton');
		startButton.addEventListener('click', function () {

			init();
			animate();

		});

		function init() {

			//Get handle to html5 video player to get the texture
			video = document.getElementById('video');
			video.play();

			 //Remove later
			setTimeout(function(){ video.currentTime = 1200; }, 500);
			texture = new THREE.VideoTexture(video);

			//Remove later
			const overlay = document.getElementById('overlay');
			overlay.remove();

			scene = new THREE.Scene();

			//Create a sphere with the video texture inside and a camera thats controlled by the device orientation for each view (left/right eye)
			for (let index = 0; index < views.length; ++index) {

				const view = views[index];

				view.camera.layers.enable(view.layer);

				const geometry = new THREE.SphereGeometry(500, 60, 40);
				geometry.scale(- 1, 1, 1);

				const uvs = geometry.attributes.uv.array;
				for (let i = 0; i < uvs.length; i += 2) {
					uvs[i] *= 0.5;
					uvs[i] += view.uvOffset; //shift texture e.g. get the right side of stereoscopic video for right eye
				}

				const material = new THREE.MeshBasicMaterial({ map: texture });
				const mesh = new THREE.Mesh(geometry, material);

				view.device = new DeviceOrientationControls(view.camera)

				mesh.layers.set(view.layer);
				scene.add(mesh);

			}

			//Setup renderer for WEBGL
			renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			//Handle browser resize
			window.addEventListener('resize', onWindowResize);

		}	 

		function animate() {

			window.requestAnimationFrame(animate);

			// Render each view (left/right eye)
			for (let index = 0; index < views.length; ++index) {

				const view = views[index];

				view.device.update();

				view.camera.layers.disableAll();
				view.camera.layers.enable(view.layer);

				renderer.setViewport(view.viewPort);
				renderer.setScissor(view.viewPort);
				renderer.setScissorTest(true);

				view.camera.updateProjectionMatrix();	
				
				renderer.render(scene, view.camera);

			}
		}

		function onWindowResize() {

			views.forEach(view => {

				view.camera.aspect = window.innerWidth / window.innerHeight;
				view.camera.updateProjectionMatrix();

			});
			
			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		function changeOrientation(event) {

			//event.preventDefault();

		}

	</script>
</body>

</html>